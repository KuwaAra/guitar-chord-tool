<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>コードトーン学習アプリ (Web版)</title>
    <style>
        /* --- 全体のスタイル --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", "Yu Gothic", "Meiryo", sans-serif;
            background-color: #f0f0f0;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            margin: 0;
        }

        #app-container {
            width: 100%;
            max-width: 1100px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 20px;
        }

        /* --- 各セクションのスタイル --- */
        .frame {
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .frame-title {
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        /* --- 入力フォーム --- */
        #input-frame .input-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        #input-frame label {
            width: 120px;
        }

        #input-frame input[type="number"] {
            width: 60px;
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        #chord-inputs-container .chord-input-row {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

            #chord-inputs-container .chord-input-row label {
                width: 80px;
            }

            #chord-inputs-container .chord-input-row input {
                flex-grow: 1;
                padding: 5px;
                border-radius: 4px;
                border: 1px solid #ccc;
            }

        /* --- 情報表示エリア --- */
        #info-display {
            display: flex;
            align-items: center;
            background-color: #fff8e1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
        }

        #beat-indicator {
            display: flex;
            gap: 5px;
            padding-right: 20px;
        }

        .beat-light {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #555;
            transition: background-color 0.1s;
        }

        #current-chord-label {
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            flex-grow: 1;
        }

        /* --- 指板 --- */
        #fretboard-grid {
            display: grid;
            gap: 1px;
            background-color: #666;
            border: 1px solid #666;
            margin: 20px 0;
        }

        .fretboard-cell {
            background-color: #eee;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.9em;
            min-height: 50px;
        }

        .fret-content-cell {
            background-color: #fff;
            font-weight: bold;
            transition: background-color 0.1s;
        }

        .fret-border-odd {
            background-color: steelblue !important;
        }

        /* --- コードトーンの色 --- */
        .tone-R {
            background-color: #e74c3c !important;
            color: white;
        }

        .tone-M3 {
            background-color: #f39c12 !important;
            color: white;
        }

        .tone-m3 {
            background-color: #f1c40f !important;
            color: #333;
        }

        .tone-P5 {
            background-color: #2ecc71 !important;
            color: white;
        }

        .tone-b5 {
            background-color: #e84393 !important;
            color: white;
        }

        .tone-M7 {
            background-color: #3498db !important;
            color: white;
        }

        .tone-m7 {
            background-color: #9b59b6 !important;
            color: white;
        }

        .tone-bb7 {
            background-color: #c0392b !important;
            color: white;
        }

        /* --- ヒント表示の色 --- */
        .hint-R {
            background-color: #f5b7b1 !important;
            color: #333;
        }

        .hint-M3 {
            background-color: #fdebd0 !important;
            color: #333;
        }

        .hint-m3 {
            background-color: #fef9e7 !important;
            color: #333;
        }

        .hint-P5 {
            background-color: #d5f5e3 !important;
            color: #333;
        }

        .hint-b5 {
            background-color: #fadbd8 !important;
            color: #333;
        }

        .hint-M7 {
            background-color: #d6eaf8 !important;
            color: #333;
        }

        .hint-m7 {
            background-color: #ebdef0 !important;
            color: #333;
        }

        .hint-bb7 {
            background-color: #eaeded !important;
            color: #333;
        }

        /* --- 重複表示の色 --- */
        .overlap {
            background-color: #e8daef !important;
            color: black;
            font-size: 0.7em !important;
        }

        /* --- コントロール --- */
        #controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
        }

            .control-row label {
                margin: 0 5px 0 10px;
            }

        button {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ccc;
            background-color: #f8f8f8;
            cursor: pointer;
            font-size: 0.9em;
        }

            button:hover {
                background-color: #eee;
            }

            button:disabled {
                cursor: not-allowed;
                opacity: 0.6;
            }

        /* --- 表示/非表示 --- */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>

    <div id="app-container">
        <div id="input-frame" class="frame">
            <div class="frame-title">設定入力</div>
            <div class="input-row">
                <label for="total-chords-input">総コード数は？:</label>
                <input type="number" id="total-chords-input" value="4" min="1" max="16">
            </div>
            <div id="chord-inputs-container"></div>
            <button id="start-app-btn" style="margin-top: 15px;">練習開始</button>
        </div>

        <div id="display-frame" class="frame hidden">
            <div id="info-display">
                <div id="beat-indicator"></div>
                <div id="current-chord-label"></div>
            </div>
            <div id="fretboard-grid"></div>
            <div id="controls">
                <div class="control-row">
                    <button id="toggle-play-btn">▶ 開始</button>
                    <label for="bpm-input">BPM:</label>
                    <input type="number" id="bpm-input" value="90" style="width: 50px;">
                    <label for="beats-input">拍数:</label>
                    <input type="number" id="beats-input" value="4" style="width: 40px;">

                    <label class="checkbox-label"><input type="checkbox" id="metronome-on-check" checked> メトロノーム</label>
                    <label class="checkbox-label"><input type="checkbox" id="fret-22-check"> 22Fまで表示</label>
                    <label class="checkbox-label"><input type="checkbox" id="show-hint-check" checked> 次のコードをヒント表示</label>
                </div>
                <div class="control-row">
                    <button id="prev-chord-btn">← 前へ</button>
                    <button id="next-chord-btn">次へ →</button>
                    <button id="stop-app-btn">設定に戻る</button>
                </div>
            </div>
        </div>
    </div>

    <script>
// =================================================================================
// --- 1. 定数とデータ定義 ---
// =================================================================================
const NOTES_DATA = [
    { half: 0, sharp: 'C', flat: '' }, { half: 1, sharp: 'C#', flat: 'Db' },
    { half: 2, sharp: 'D', flat: '' }, { half: 3, sharp: 'D#', flat: 'Eb' },
    { half: 4, sharp: 'E', flat: '' }, { half: 5, sharp: 'F', flat: '' },
    { half: 6, sharp: 'F#', flat: 'Gb' }, { half: 7, sharp: 'G', flat: '' },
    { half: 8, sharp: 'G#', flat: 'Ab' }, { half: 9, sharp: 'A', flat: '' },
    { half: 10, sharp: 'A#', flat: 'Bb' }, { half: 11, sharp: 'B', flat: '' }
];
const CHORD_DEFINITIONS = {
    'M': { intervals: [0, 4, 7], degrees: ['R', 'M3', 'P5'] },
    'm': { intervals: [0, 3, 7], degrees: ['R', 'm3', 'P5'] },
    'M7': { intervals: [0, 4, 7, 11], degrees: ['R', 'M3', 'P5', 'M7'] },
    'm7': { intervals: [0, 3, 7, 10], degrees: ['R', 'm3', 'P5', 'm7'] },
    '7': { intervals: [0, 4, 7, 10], degrees: ['R', 'M3', 'P5', 'm7'] },
    'dim': { intervals: [0, 3, 6], degrees: ['R', 'm3', 'b5'] },
    'm7b5': { intervals: [0, 3, 6, 10], degrees: ['R', 'm3', 'b5', 'm7'] },
    'dim7': { intervals: [0, 3, 6, 9], degrees: ['R', 'm3', 'b5', 'bb7'] }
};
const FRETBOARD_STRINGS_BASE_NOTES = { '1弦': 4, '2弦': 11, '3弦': 7, '4弦': 2, '5弦': 9, '6弦': 4 };

// =================================================================================
// --- 2. 状態管理 ---
// =================================================================================
const state = {
    chordProgression: [],
    currentChordIndex: 0,
    beatCount: 0,
    isPlaying: false,
    isInHintView: false,
    metronomeTimerId: null
};

// =================================================================================
// --- 3. DOM要素の取得 ---
// =================================================================================
const dom = {};
document.addEventListener('DOMContentLoaded', () => {
    Object.assign(dom, {
        inputFrame: document.getElementById('input-frame'),
        displayFrame: document.getElementById('display-frame'),
        totalChordsInput: document.getElementById('total-chords-input'),
        chordInputsContainer: document.getElementById('chord-inputs-container'),
        startAppBtn: document.getElementById('start-app-btn'),
        stopAppBtn: document.getElementById('stop-app-btn'),
        beatIndicator: document.getElementById('beat-indicator'),
        currentChordLabel: document.getElementById('current-chord-label'),
        fretboardGrid: document.getElementById('fretboard-grid'),
        togglePlayBtn: document.getElementById('toggle-play-btn'),
        bpmInput: document.getElementById('bpm-input'),
        beatsInput: document.getElementById('beats-input'),
        metronomeOnCheck: document.getElementById('metronome-on-check'),
        fret22Check: document.getElementById('fret-22-check'),
        showHintCheck: document.getElementById('show-hint-check'),
        prevChordBtn: document.getElementById('prev-chord-btn'),
        nextChordBtn: document.getElementById('next-chord-btn'),
    });
    init();
});

// =================================================================================
// --- 4. ヘルパー関数 ---
// =================================================================================
const getNoteName = (halfToneIndex, preferSharp = true) => {
    halfToneIndex = (halfToneIndex % 12 + 12) % 12;
    const noteData = NOTES_DATA.find(n => n.half === halfToneIndex);
    if (!noteData) return "";
    return preferSharp || !noteData.flat ? noteData.sharp : noteData.flat;
};
const getHalfToneIndex = (noteName) => {
    const note = NOTES_DATA.find(n => n.sharp.toLowerCase() === noteName.toLowerCase() || (n.flat && n.flat.toLowerCase() === noteName.toLowerCase()));
    return note ? note.half : -1;
};
const shouldPreferSharps = (rootNote) => {
    const trimmedRoot = rootNote.trim().toUpperCase();
    const flatKeys = ["F", "BB", "EB", "AB", "DB", "GB", "CB"];
    return !flatKeys.includes(trimmedRoot);
};
const parseChordString = (fullChordString) => {
    const sortedTypes = Object.keys(CHORD_DEFINITIONS).sort((a, b) => b.length - a.length);
    for (const c_type of sortedTypes) {
        if (fullChordString.endsWith(c_type)) {
            const root = fullChordString.slice(0, -c_type.length);
            return { root: root.trim(), type: c_type };
        }
    }
    return { root: fullChordString.trim(), type: 'M' };
};

// =================================================================================
// --- 5. UI更新関数 ---
// =================================================================================

function generateChordInputFields() {
    const numChords = parseInt(dom.totalChordsInput.value) || 0;
    dom.chordInputsContainer.innerHTML = '';
    for (let i = 0; i < numChords; i++) {
        const row = document.createElement('div');
        row.className = 'chord-input-row';
        row.innerHTML = `<label for="chord-input-${i}">コード ${i + 1}:</label><input type="text" id="chord-input-${i}" class="chord-input">`;
        dom.chordInputsContainer.appendChild(row);
    }
}

function createBeatIndicators() {
    dom.beatIndicator.innerHTML = '';
    const totalBeats = parseInt(dom.beatsInput.value) || 4;
    for (let i = 0; i < totalBeats; i++) {
        const light = document.createElement('div');
        light.className = 'beat-light';
        dom.beatIndicator.appendChild(light);
    }
}

function updateBeatDisplay() {
    const lights = dom.beatIndicator.children;
    for (let i = 0; i < lights.length; i++) {
        lights[i].style.backgroundColor = '#555';
    }
    if (state.isPlaying && state.beatCount >= 0 && state.beatCount < lights.length) {
        lights[state.beatCount].style.backgroundColor = state.beatCount === 0 ? '#e74c3c' : '#f1c40f';
    }
}

function populateFretboardGrid() {
    dom.fretboardGrid.innerHTML = '';
    const maxFret = dom.fret22Check.checked ? 22 : 12;
    const stringNames = ['1弦', '2弦', '3弦', '4弦', '5弦', '6弦'];

    // CSS Gridの列テンプレートを動的に設定
    const stringColWidth = "40px";
    const fret0ColWidth = "25px";
    dom.fretboardGrid.style.gridTemplateColumns = `${stringColWidth} ${fret0ColWidth} repeat(${maxFret}, 1fr)`;

    // ヘッダー行
    dom.fretboardGrid.insertAdjacentHTML('beforeend', '<div class="fretboard-cell"></div>');
    dom.fretboardGrid.insertAdjacentHTML('beforeend', '<div class="fretboard-cell">0</div>');
    for (let f = 1; f <= maxFret; f++) {
        const isOdd = (f % 2 !== 0 && f !== 1 && f !== 13);
        dom.fretboardGrid.insertAdjacentHTML('beforeend', `<div class="fretboard-cell ${isOdd ? 'fret-border-odd' : ''}">${f}</div>`);
    }

    // 弦とフレットのセル
    stringNames.forEach(stringName => {
        dom.fretboardGrid.insertAdjacentHTML('beforeend', `<div class="fretboard-cell">${stringName}</div>`);
        for (let fret = 0; fret <= maxFret; fret++) {
            const isOdd = (fret % 2 !== 0 && fret !== 1 && fret !== 13);
            const cell = document.createElement('div');
            cell.className = `fretboard-cell fret-content-cell ${isOdd ? 'fret-border-odd' : ''}`;
            cell.id = `cell-${stringName}-${fret}`;
            dom.fretboardGrid.appendChild(cell);
        }
    });
}

function updateFretboardDisplay(showHint = false, hintDirection = 1) {
    // リセット
    const cells = document.querySelectorAll('.fret-content-cell');
    cells.forEach(cell => {
        cell.textContent = '';
        cell.className = cell.className.replace(/tone-\S+|hint-\S+|overlap/g, '').trim();
    });

    const currentChord = parseChordString(state.chordProgression[state.currentChordIndex]);
    const currentDef = CHORD_DEFINITIONS[currentChord.type];
    if (!currentDef) return;
    const currentRootHT = getHalfToneIndex(currentChord.root);

    let nextDef = null, nextRootHT = null;
    if (showHint && state.chordProgression.length > 1) {
        const nextIndex = (state.currentChordIndex + hintDirection + state.chordProgression.length) % state.chordProgression.length;
        const nextChord = parseChordString(state.chordProgression[nextIndex]);
        nextDef = CHORD_DEFINITIONS[nextChord.type];
        if (nextDef) nextRootHT = getHalfToneIndex(nextChord.root);
    }

    const maxFret = dom.fret22Check.checked ? 22 : 12;
    const stringNames = ['1弦', '2弦', '3弦', '4弦', '5弦', '6弦'];

    stringNames.forEach(stringName => {
        const baseNote = FRETBOARD_STRINGS_BASE_NOTES[stringName];
        for (let fret = 0; fret <= maxFret; fret++) {
            const cell = document.getElementById(`cell-${stringName}-${fret}`);
            if (!cell) continue;

            const noteHT = (baseNote + fret);
            let currentDegree = null, nextDegree = null;

            const currentInterval = (noteHT - currentRootHT + 12) % 12;
            if (currentDef.intervals.includes(currentInterval)) {
                currentDegree = currentDef.degrees[currentDef.intervals.indexOf(currentInterval)];
            }
            if (nextDef) {
                const nextInterval = (noteHT - nextRootHT + 12) % 12;
                if (nextDef.intervals.includes(nextInterval)) {
                    nextDegree = nextDef.degrees[nextDef.intervals.indexOf(nextInterval)];
                }
            }

            if (currentDegree && nextDegree) {
                cell.textContent = `${currentDegree}/${nextDegree}`;
                cell.classList.add('overlap');
            } else if (currentDegree) {
                cell.textContent = currentDegree;
                cell.classList.add(`tone-${currentDegree}`);
            } else if (nextDegree) {
                cell.textContent = nextDegree;
                cell.classList.add(`hint-${nextDegree}`);
            }
        }
    });
}

function displayCurrentChord() {
    if (!state.chordProgression || state.chordProgression.length === 0) return;
    const fullChordString = state.chordProgression[state.currentChordIndex];
    const parsed = parseChordString(fullChordString);
    const def = CHORD_DEFINITIONS[parsed.type];
    if (!def) return;

    const rootHT = getHalfToneIndex(parsed.root);
    const preferSharps = shouldPreferSharps(parsed.root);
    let toneDisplay = def.degrees.map((deg, i) => {
        const noteName = getNoteName(rootHT + def.intervals[i], preferSharps);
        return `(${deg})${noteName}`;
    }).join(' ');
    dom.currentChordLabel.textContent = `${fullChordString} || ${toneDisplay}`;

    let isHintBeat = false;
    if (dom.showHintCheck.checked && state.isPlaying) {
        const totalBeats = parseInt(dom.beatsInput.value) || 4;
        if (state.beatCount === totalBeats - 1) {
            isHintBeat = true;
        }
    }
    updateFretboardDisplay(isHintBeat);
}

// =================================================================================
// --- 6. アプリケーションロジック ---
// =================================================================================

function startApp() {
    const inputs = document.querySelectorAll('.chord-input');
    state.chordProgression = Array.from(inputs).map(input => input.value.trim()).filter(val => val);
    if (state.chordProgression.length === 0) {
        alert("コード進行を少なくとも1つ入力してください。");
        return;
    }

    dom.inputFrame.classList.add('hidden');
    dom.displayFrame.classList.remove('hidden');

    state.currentChordIndex = 0;
    state.beatCount = 0;
    state.isPlaying = false;
    state.isInHintView = false;

    createBeatIndicators();
    populateFretboardGrid();
    displayCurrentChord();
    updateBeatDisplay();
}

function stopApp() {
    togglePlay(false); // 確実に停止
    dom.displayFrame.classList.add('hidden');
    dom.inputFrame.classList.remove('hidden');
}

function togglePlay(forceState) {
    state.isPlaying = typeof forceState === 'boolean' ? forceState : !state.isPlaying;

    if (state.isPlaying) {
        dom.togglePlayBtn.textContent = "■ 停止";
        [dom.prevChordBtn, dom.nextChordBtn].forEach(btn => btn.disabled = true);
        state.beatCount = 0;
        state.isInHintView = false;
        onMetronomeBeat();
    } else {
        dom.togglePlayBtn.textContent = "▶ 開始";
        [dom.prevChordBtn, dom.nextChordBtn].forEach(btn => btn.disabled = false);
        clearTimeout(state.metronomeTimerId);
        state.metronomeTimerId = null;
        state.isInHintView = false;
        updateBeatDisplay();
        displayCurrentChord();
    }
}

function onMetronomeBeat() {
    if (!state.isPlaying) return;

    if (dom.metronomeOnCheck.checked) {
        // 簡単な音の再生 (Web Audio API)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioCtx.createOscillator();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
        oscillator.connect(audioCtx.destination);
        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.1);
    }

    displayCurrentChord();
    updateBeatDisplay();

    state.beatCount++;
    const totalBeats = parseInt(dom.beatsInput.value) || 4;
    if (state.beatCount >= totalBeats) {
        state.beatCount = 0;
        state.currentChordIndex = (state.currentChordIndex + 1) % state.chordProgression.length;
    }

    const bpm = parseInt(dom.bpmInput.value) || 90;
    const beatDuration = 60000 / (bpm > 0 ? bpm : 90);
    state.metronomeTimerId = setTimeout(onMetronomeBeat, beatDuration);
}

function navigateChord(direction) {
    if (state.isPlaying) return;

    if (!dom.showHintCheck.checked || state.isInHintView) {
        state.currentChordIndex = (state.currentChordIndex + direction + state.chordProgression.length) % state.chordProgression.length;
        state.beatCount = 0;
        state.isInHintView = false;
        displayCurrentChord();
    } else {
        updateFretboardDisplay(true, direction);
        state.isInHintView = true;
    }
}

// =================================================================================
// --- 7. 初期化とイベントリスナー ---
// =================================================================================

function init() {
    // イベントリスナーの設定
    dom.totalChordsInput.addEventListener('change', generateChordInputFields);
    dom.startAppBtn.addEventListener('click', startApp);
    dom.stopAppBtn.addEventListener('click', stopApp);
    dom.togglePlayBtn.addEventListener('click', () => togglePlay());
    dom.beatsInput.addEventListener('change', () => {
        createBeatIndicators();
        updateBeatDisplay();
    });
    dom.fret22Check.addEventListener('change', () => {
        populateFretboardGrid();
        displayCurrentChord();
    });
    dom.showHintCheck.addEventListener('change', () => {
        state.isInHintView = false;
        displayCurrentChord();
    });
    dom.prevChordBtn.addEventListener('click', () => navigateChord(-1));
    dom.nextChordBtn.addEventListener('click', () => navigateChord(1));

    // 初期状態のUIを生成
    generateChordInputFields();
}

    </script>

</body>
</html>